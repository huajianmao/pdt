# 性能测试报告
PDT是基于开源项目WDT编译生成适用于Windows环境的数据传输工具，利用多个TCP路径最大化提高两个系统之间传送文件的速率及效率。
PDT协议支持Windows及Windows Server操作系统。

## 测试目的
依据合同要求，本报告主要测试验证PDT在1Gbit/s网络中的性能。

## 测试方法与内容
### 测试方法
为测试PDT在1Gbit/s环境中的速度，本报告主要通过对比PDT以及FTP这两种方法的数据传输速率，
以测试合同要求网络中，PDT的平均传输速率与理想网络环境传输速率的百分比，以及相同环境下PDT与其他数据传输方法的性能比较。

### 测试内容
1. 测试1Gbit/s环境下，PDT、FTP这两种方法，分别传输大文件、大量小文件、混合类型文件的数据传输性能。
2. 本测试报告共测试 `2种工具 * 4类数据 * 2次/组` 共16项，测试性能取每组的两次平均值。

## 测试环境
### 软硬件环境
#### 硬件环境
 - 测试机器配置：Intel Xeon CPU E5-2650 (2处理器)，16GB内存
 - 网络环境配置：HP Ethernet 1Gbits 4-Port Adapter，CAT 6e 网线直连
 - 硬盘读写性能：本地直接写硬盘（dd命令）的速度为 160 MBytes/sec

#### 软件环境
 - 操作系统：Windows Server 2008 R2 Enterprise 64位
 - PDT：WDT版本为`v 1.26.1603040 p 26.`，由Cygwin x86\_64 2.4.1编译
 - FTP：服务端windows Server IIS FTP服务，客户端 Cygwin + LFTP Version 4.6.5

### 测试数据
本测试中使用了4组测试数据，包括大文件(large)、中等大小的文件(small)、小型文件(minor)、混合型文件(mixed)。
 - large: 16个文件，每个文件大小为2G，共32G
 - small：4243个文件，文件大小为1k~10M随机大小，共19.8G
 - minor：102645个文件，文件大小为1k~400k随即大小，共19.5G
 - mixed：small和minor数据集的合集，39.3G 

| 数据集   | 文件大小      |  文件数目    | 数据集总量 |
|----------|---------------|--------------|------------|
|large     | 2GB/file      |  16 files    | 32GB       |
|small     | 1k~10M B/file | 4243 files   | 19.8GB     |
|minor     | 1k~400k B/file| 102645 files | 19.5GB     |
|mixed     | 1k~10M B/file | 106888 files | 39.3GB     |

本报告中所有测试所使用数据通过`dd`生成，生成脚本如下：
``` shell
PDT_TEST_DATA_DIR=/tmp/pdt-test/data
mkdir $PDT_TEST_DATA_DIR/{large,mixed,small,minor}

## 我们也可以使用`head -c`来生成数据
# 生成大小为2GB的随机内容的文件共16个，数据大小总量为32GB
for file in `seq 1 16`; do
  dd if=/dev/urandom of=${PDT_TEST_DATA_DIR}/large/2GB.${file}.dd bs=64M count=32
done

# 生成1KB到10MB大小(整数MB)的文件，数据大小总量为19.8GB
tag=1
leftSize=20777216
while [ "$leftSize" -gt "0" ]; do
  thisGenerated=$RANDOM
  thisGenerated=`expr "$thisGenerated" % "10240"`
  if [ "$thisGenerated" -eq "0" ]; then
    continue;
  fi
  if [ "$thisGenerated" -gt "$leftSize" ]; then
    thisGenerated=$leftSize
  fi
  dd if=/dev/urandom of=${PDT_TEST_DATA_DIR}/small/${tag}.${thisGenerated}K.dd bs=1K count=$thisGenerated
  leftSize=`expr "$leftSize" - "$thisGenerated"`
  tag=`expr "$tag" + "1"`
done

# 生成1KB到400KB大小(整数KB)的文件，数据大小总量为19.5GB
tag=1
leftSize=20497152
while [ "$leftSize" -gt "0" ]; do
  thisGenerated=$RANDOM
  thisGenerated=`expr "$thisGenerated" % "400"`
  if [ "$thisGenerated" -eq "0" ]; then
    continue;
  fi
  if [ "$thisGenerated" -gt "$leftSize" ]; then
    thisGenerated=$leftSize
  fi
  dd if=/dev/urandom of=${PDT_TEST_DATA_DIR}/minor/${tag}.${thisGenerated}K.dd bs=1K count=$thisGenerated
  leftSize=`expr "$leftSize" - "$thisGenerated"`
  tag=`expr "$tag" + "1"`
done
```

## 测试结果与分析
### 测试命令
- wdt测试命令
  - 接收端：`wdt.exe -directory RECEIVE_DIR -transfer_id=xxxxxxxx -run_as_daemon=true -ipv4`
   `transfer_id`为指定的传输id
  - 发送端：`wdt.exe -directory SEND_DATA_DIR -destination REVEIVER_IP -transfer_id xxxxxxxx`
    - `SEND_DATA_DIR`目录下包含一次测试需要传输的数据
    - `transfer_id`后参数由接收端命令生成
- lftp测试命令
  - `mirror -R --parallel=8 DIRECTORY`
    - `DIRECTORY`目录为数据的存放目录

### 测试结果
经过使用每组数据集对两种传输工具分别做多次试验，结果如下表所示：

|            数据集              |     wdt.1    |     wdt.2    |   lftp.1     |   lftp.2     |   wdt.avg    |   lftp.avg   |
|:------------------------------:|--------------|--------------|--------------|--------------|--------------|--------------|
|**large** <br> (2GB/file)       | 113.055 MB/s | 113.114 MB/s | 64.44 MB/s   | 64.13 MB/s   | 113.085 MB/s | 64.28 MB/s   |
|**small** <br> (1KB~10MB/file)  | 111.156 MB/s | 112.756 MB/s | 100.34 MB/s  | 101.10 MB/s  | 111.956 MB/s | 100.72 MB/s  |
|**minor** <br> (1KB~400KB/file) | 97.304 MB/s  | 98.383 MB/s  | 59.59 MB/s   | 59.39 MB/s   | 97.844 MB/s  | 59.49 MB/s   |
|**mixed** <br> (small+minor)    | 89.320 MB/s  | 84.281 MB/s  | 25.70 MB/s   | 26.08 MB/s   | 86.801 MB/s  | 25.89 MB/s   |

![alt text][wdt.vs.lftp]

### 结果分析
通过对两种数据工具、四种数据集的测试，从实验结果看，pdt基本符合合同要求。
 1. 相对于网络理论速度（1Gbits/s，即125MBytes/s），pdt在所有数据集情况下，当文件较大时，基本能达到90%左右的网络负载；即使对于小文件，PDT的网络性能也能达到78.3%。
 2. 相同情况下（网络环境、数据集），pdt的性能基本要明显好于lftp的性能。wdt的性能基本上是lftp性能160%以上。
 3. 总体来说，pdt基本符合合同要求。

[wdt.vs.lftp]: ./wdt.vs.lftp.jpg "PDT vs. LFTP"
