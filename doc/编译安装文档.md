# Parallel Data Transfer (PDT)

PDT是基于[WDT](https://github.com/facebook/wdt)专门为Windows平台定制编译而成的数据传输工具。
PDT通过在Cygwin环境下对[WDT](https://github.com/facebook/wdt)进行编译，并提取编译生成的二进制文件及其依赖的cygwin库，
从而形成Windows环境下可独立运行的PDT数据传输软件包。

由于[WDT](https://github.com/facebook/wdt)依赖于[double-conversion](https://github.com/google/double-conversion),
[gflags](https://github.com/gflags/gflags), [glog](https://github.com/google/glog),
[googletest](https://github.com/google/googletest), [folly](https://github.com/facebook/folly)
等软件库，因此在编译[WDT](https://github.com/facebook/wdt)需要正确编译安装这些软件库。

另外，如上文所述，PDT是在Cygwin环境下进行编译的，因此，若要从零完整编译PDT，则需要安装Cygwin环境。
但若仅运行PDT，则无需安装Cygwin环境。

PDT的编译安装过程主要包括以下几个步骤，或者直接`sh scripts/setup.sh`调用代码包中的中的编译脚本，完成整个代码编译过程：

## 安装Cygwin X64 环境
Cygwin安装文件可以从[它的官网](http://cygwin.com/setup-x86_64.exe)下载得到。运行Cygwin的安装程序即可完成Cygwin的安装。
由于[WDT](https://github.com/facebook/wdt)的编译过程依赖一些第三方库，因此需要将这些第三方库在Cygwin环境中正确安装。
WDT编译过程所依赖的第三方库主要包括：
 - gcc-g++
 - cmake
 - make
 - automake1.14
 - autoconf-archive
 - autoconf2.5
 - gdb
 - git
 - openssh
 - openssl-devel
 - pkg-config
 - patch
 - libboost-devel
 - libtool

### 第三方库安装的方法主要有两种
 1. 通过使用[apt-cyg](../apt-cyg)脚本，批量安装所需的软件包。
    由于apt-cyg脚本本身依赖于`wget`, `tar`, `gawk`, `xz`以及`bzip2`等软件，
    我们需要在执行Cygwin安装程序时，手动选择安装这几个软件包。
    然后执行以下脚本批量安装pdt所需工具和第三方库：
    
    ```
    apt-cyg install -m http://mirrors.aliyun.com/cygwin \
      gcc-g++ cmake make automake1.14 autoconf-archive autoconf2.5 gdb openssh openssl-devel\
      pkg-config patch libboost-devel libtool
    ```

 2. 另一种方法是，重新执行Cygwin安装程序，随后逐个根据软件包名，搜索对应软件并选择安装。

## 下载依赖源码
PDT主要依赖[double-conversion](https://github.com/google/double-conversion),
[gflags](https://github.com/gflags/gflags), [glog](https://github.com/google/glog),
[googletest](https://github.com/google/googletest), [folly](https://github.com/facebook/folly), [wdt](https://github.com/facebook/wdt)等软件。
可以在Cygwin环境中，通过git分别下载相应代码文件。
WDT目前仅支持Linux、MacOSX环境，若要在Cygwin下正确运行，需对其进行打补丁，主要依赖于两个补丁文件[Patch for glog](../patch/glog.patch), [Patch for wdt](../patch/wdt.patch)。
具体过程如下：

 1. 在Cygwin环境中，建立放置代码的文件夹，并设置环境变量

   ```
   WORKSPACE=~/workspace/pdt; mkdir -p $WORKSPACE; mkdir -p $WORKSPACE/src; mkdir -p $WORKSPACE/patch; cd $WORKSPACE
   
   export INSTALL_PREFIX=/tmp/pdt
   mkdir -p $INSTALL_PREFIX/bin $INSTALL_PREFIX/lib
   export PATH=$INSTALL_PREFIX/bin:$INSTALL_PREFIX/lib:$PATH
   ```
  
 2. 通过git下载所需软件包

   ```
   cd $WORKSPACE/src
   git clone https://github.com/google/double-conversion
   git clone https://github.com/gflags/gflags
   git clone https://github.com/google/glog
   git clone https://github.com/google/googletest
   git clone https://github.com/facebook/folly
   git clone https://github.com/facebook/wdt
   cd $WORKSPACE
   ```

 3. 对glog以及wdt打补丁
   ```
   # 将补丁文件拷贝到 $WORKSPACE/patch目录中
   (cd src/glog; git apply ../../patch/glog.patch;)
   (cd src/wdt; git apply ../../patch/wdt.patch;)
   ```

## 编译依赖库及wdt
由于依赖库之间也存在依赖关系，因此，为保证编译过程正确，请务必按以下顺序依次编译。

```
cd $WORKSPACE
mkdir -p build
# Compile double-conversion
(mkdir build/double-conversion; cd build/double-conversion; cmake -DBUILD_SHARED_LIBS=on -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX ../../src/double-conversion; make -j 2; make install)

# Compile gflags
(mkdir build/gflags; cd build/gflags; cmake -DBUILD_SHARED_LIBS=on -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX -DGFLAGS_NAMESPACE=google ../../src/gflags; make -j 2; make install)

# Compile glog
(cd src/glog; git apply ../../patch/glog.patch;)
(export CXXFLAGS="-fPIC" && mkdir build/glog; cd build/glog; cmake -DBUILD_SHARED_LIBS=on -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX ../../src/glog; make; make -j 2; make install)

# Compile google test
(mkdir build/googletest; cd build/googletest; cmake -DBUILD_SHARED_LIBS=on -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX ../../src/googletest; make; make -j 2; make install)

(mkdir build/wdt; cd build/wdt; cmake -DBUILD_TESTING=1 -DBUILD_SHARED_LIBS=on -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX ../../src/wdt;  make; make -j 2; make install;)
```

## 打包PDT软件
在Cygwin环境中编译生成的软件依赖于Cygwin1.dll等库文件。
为了保证程序在Windows环境（未安装Cygwin）下能够正确执行，我们需要将编译生成的dll库以及Cygwin库文件等一起打包。
编译完成后，即可在指定的WINDOWS_EXE_DIR目录中找到可执行exe软件包。
打包过程如下：

```
  export WINDOWS_EXE_DIR=$INSTALL_PREFIX/exe
  mkdir -p $WINDOWS_EXE_DIR

  cp /bin/cygwin1.dll $WINDOWS_EXE_DIR/

  cp /bin/cyggcc_s-seh-1.dll $WINDOWS_EXE_DIR/
  cp /bin/cygboost_system-1_58.dll $WINDOWS_EXE_DIR/
  cp /bin/cygstdc++-6.dll $WINDOWS_EXE_DIR/
  cp /bin/cyggcc_s-seh-1.dll $WINDOWS_EXE_DIR/
  cp /bin/cygcrypto-1.0.0.dll $WINDOWS_EXE_DIR/
  cp /bin/cygz.dll $WINDOWS_EXE_DIR/

  cp $INSTALL_PREFIX/lib/cyggflags-*.dll $WINDOWS_EXE_DIR/
  cp $INSTALL_PREFIX/bin/cygglog-*.dll $WINDOWS_EXE_DIR/
  cp $INSTALL_PREFIX/bin/cygwdt_min.dll $WINDOWS_EXE_DIR/
  cp $INSTALL_PREFIX/bin/cygfolly4wdt.dll $WINDOWS_EXE_DIR/
  cp $INSTALL_PREFIX/bin/wdt.exe $WINDOWS_EXE_DIR/
```

## WDT使用
将软件包拷贝到所需路径，分别在接收端和发送端CMD命令行执行下列指令，即可进行文件传输。  

- 接收端： `wdt.exe -directory RECEIVE_DIR -transfer_id xxxxxxxx -run_as_daemon=true -ipv4`
  - `RECEIVE_DIR`表示接收端存放接收数据的目录。
  - `transfer_id`指定接收端的传输id。不使用该参数则wdt程序自动生成。
  - `run_as_daemon`设置为true，指定接收端以daemon模式运行，一直在线监听。
- 发送端： `wdt.exe -directory SEND_DATA_DIR -destination REVEIVER_IP -transfer_id xxxxxxxx`
  - `SEND_DATA_DIR`目录下包含一次测试需要传输的数据
  - `transfer_id`接收端指定的transfer_id参数，或接收端自动生成的transfer_id。
